angular.module("ngAmbassador.activityFeed",["ngAmbassador.services","ngAmbassador.api"]).directive("gaActivityFeed",["$api","$timeout","$promiseKeeper",function($api,$timeout,$promiseKeeper){"use strict";return{restrict:"E",scope:{endpoint:"@",numberOfItems:"@",columns:"@",feedTitle:"@",companyCurrency:"@",companyPoints:"@",ambassadorTemplate:"=",config:"=",filters:"="},templateUrl:"../ambassador/templates/activity-feed.html",link:function(scope,element,attrs){function loadActivity(){scope.activities=[],scope.feedColumns=[];var requestData=void 0!==scope.filters?angular.copy(scope.filters):{};requestData.page_size=scope.numberOfItems;var loadingPromise=$promiseKeeper.add();$api.use("default").all(scope.endpoint).getList(requestData).then(function(data){loadingPromise.deferred.resolve(),scope.activities=data,1==scope.columns?(getOrientation(scope.activities),scope.feedColumns[0]=scope.activities):(itemsPerColumn=Math.ceil(data.length/scope.columns),splitIntoColumns(scope.activities))})}function splitIntoColumns(data){for(var i=0;i<scope.columns;i++)scope.feedColumns.push([]),angular.forEach(data,function(activity,index){index>=itemsPerColumn*i&&index<itemsPerColumn*(i+1)&&(activity.orientation="right",scope.feedColumns[i].push(activity))})}function getOrientation(data){angular.forEach(data,function(activity,index){0===index?activity.orientation="left":activity.type!==data[index-1].type?activity.orientation="left"===data[index-1].orientation?"right":"left":activity.orientation=data[index-1].orientation})}var itemsPerColumn=Math.ceil(scope.numberOfItems/scope.columns),initialized=!1;scope.$watch("filters",function(newValue,oldValue){newValue===oldValue&&initialized!==!1||(loadActivity(),initialized=!0)},!0),scope.activityTime=function(dateTime){var now=moment.utc(),activityTime=moment.utc(dateTime),readableDiff=0,timeUnit="seconds";return now.diff(activityTime,"years")>=1?(readableDiff=now.diff(activityTime,"years"),timeUnit=1===readableDiff?"year":"years"):now.diff(activityTime,"months")>=1?(readableDiff=now.diff(activityTime,"months"),timeUnit=1===readableDiff?"month":"months"):now.diff(activityTime,"days")>=1?(readableDiff=now.diff(activityTime,"days"),timeUnit=1===readableDiff?"day":"days"):now.diff(activityTime,"hours")>=1?(readableDiff=now.diff(activityTime,"hours"),timeUnit=1===readableDiff?"hour":"hours"):now.diff(activityTime,"minutes")>=1?(readableDiff=now.diff(activityTime,"minutes"),timeUnit=1===readableDiff?"minute":"minutes"):(readableDiff=now.diff(activityTime,"seconds"),timeUnit=1===readableDiff?"second":"seconds"),"<var>"+readableDiff+"</var> "+timeUnit+" ago"}}}}]).directive("gaProgressFeed",[function(){"use strict";return{restrict:"E",scope:{steps:"="},templateUrl:"../ambassador/templates/progress-feed.html"}}]);