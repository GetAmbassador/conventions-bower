angular.module("ngAmbassador.alerts",["duScroll"]).factory("$alertMap",function(){return{createNew:function(){var stack={app:null,page:null,form:null};return{getSystem:function(type,name){if(null===stack[type])return!(stack[type]={});for(var key in stack[type])if(key===name)return stack[type][key];return!1},createSystem:function(type,name,update){return void 0===update&&(update=null),stack[type][name]={update:update,alerts:[],element:null},stack[type][name]},registerUpdate:function(type,name,update){return stack[type][name].update=update,stack[type][name]},removeSystem:function(type,name){delete stack[type][name]},addAlert:function(type,name,alert){stack[type][name].alerts.push(alert)},removeAlert:function(type,name,index){return this.getSystem(type,name).alerts.splice(index,1)},getIndex:function(alert){return stack[alert.type][alert.name].alerts.indexOf(alert)},setScrollElement:function(type,name,element){stack[type][name].element=element}}}}}).factory("$alertStack",["$document","$compile","$timeout","$alertMap",function($document,$compile,$timeout,$alertMap){var activeAlerts=$alertMap.createNew(),$alertStack={};function startTimer(options){options.timerStart=new Date,options.alertTimer=$timeout(function(){$alertStack.close(options)},options.timerVal)}function addAlert(system,options){activeAlerts.addAlert(options.type,options.name,options),options.timer&&startTimer(options),null!==system.update&&system.update(system.alerts)}return $alertStack.getAlerts=function(type,name){return activeAlerts.getSystem(type,name).alerts},$alertStack.registerSystem=function(type,name,update){var system=activeAlerts.getSystem(type,name);return system&&null!==system.update?update(system.alerts):system&&null===system.update?update((system=activeAlerts.registerUpdate(type,name,update)).alerts):(system=activeAlerts.createSystem(type,name,update),void 0!==update&&update(system.alerts)),system},$alertStack.setScrollElement=function(type,name,element){activeAlerts.setScrollElement(type,name,element)},$alertStack.deleteSystem=function(type,name){activeAlerts.removeSystem(type,name)},$alertStack.add=function(options,checked){var waitToLoad,system=activeAlerts.getSystem(options.type,options.name);if(!system&&options.register?addAlert(system=$alertStack.registerSystem(options.type,options.name),options):system||options.register||void 0!==checked?system||options.register||!checked?addAlert(system,options):(function(options){var body=$document.find("body").eq(0),angularDomEl=angular.element("<alert-system></alert-system>");angularDomEl.attr("type",options.type),angularDomEl.attr("name",options.name),angularDomEl.addClass("page");var alertSystemEl=$compile(angularDomEl)(options.scope);body.append(alertSystemEl)}(options),waitToLoad=setInterval(function(){(system=activeAlerts.getSystem(options.type,options.name))&&(clearInterval(waitToLoad),addAlert(system,options))},100)):$timeout(function(){$alertStack.add(options,!0)},500),options.scroll){var modalIsOpen=0<angular.element(document.querySelector(".modal-open")).length;options.scrollToAlert&&modalIsOpen?angular.element(document.querySelector(".modal")).scrollToElement(activeAlerts.getSystem(options.type,options.name).element,parseInt(options.scrollOffset,10),500):options.scrollToAlert?angular.element(document).scrollToElement(activeAlerts.getSystem(options.type,options.name).element,parseInt(options.scrollOffset,10),500):angular.element(document).scrollTo(0,0,500)}},$alertStack.close=function(alert,index){void 0===index&&(index=activeAlerts.getIndex(alert)),activeAlerts.removeAlert(alert.type,alert.name,index),null!==alert.callback&&alert.callback()},$alertStack.pauseTimer=function(alerts,index){var alert=alerts[index];alert.timerVal-=new Date-alert.timerStart,alert.timer&&$timeout.cancel(alert.alertTimer)},$alertStack.resumeTimer=function(alerts,index){var alert=alerts[index];alert.timer&&startTimer(alert)},$alertStack}]).provider("$alert",function(){var $alertProvider={options:{style:"info",type:"page",name:void 0,register:!1,text:"",timer:!0,timerVal:4e3,callback:null,scroll:!1,scrollToAlert:!1,scrollOffset:15,actions:null},$get:["$rootScope","$alertStack",function($rootScope,$alertStack){var $alert={add:function(alertOptions){var defaultScroll=!1;angular.isUndefined(alertOptions.scroll)&&(defaultScroll="form"===alertOptions.type);var alertScope=((alertOptions=angular.extend({},$alertProvider.options,alertOptions)).scope||$rootScope).$new();$alertStack.add({scope:alertScope,style:alertOptions.style,type:alertOptions.type,name:alertOptions.name,register:alertOptions.register,text:alertOptions.text,timer:alertOptions.timer,timerVal:alertOptions.timerVal,callback:alertOptions.callback,actions:alertOptions.actions,scroll:alertOptions.scroll||defaultScroll,scrollToAlert:alertOptions.scrollToAlert,scrollOffset:alertOptions.scrollOffset})},clearAll:function(type,alertSystem){var alerts=$alertStack.getAlerts(type,alertSystem),alertsToClose=[];angular.forEach(alerts,function(alert){alertsToClose.push(alert)}),angular.forEach(alertsToClose,function(alert){$alertStack.close(alert)})}};return $alert}]};return $alertProvider}).directive("alertSystem",["$alertStack","$timeout","$document",function($alertStack,$timeout,$document){return{restrict:"EA",template:'<div class="alert-system-inner"><alert ng-mouseenter="toggleTimer(true, $index)" ng-mouseleave="toggleTimer(false, $index)" ng-repeat="alert in alerts" ng-animate="\'alert\'" type="{{alert.style}}" close="closeAlert(alert, $index)"><i class="fa" ng-class="{\'fa-check-circle-o\': alert.style === \'success\' && !alert.snippet, \'fa-check\': alert.style === \'success\' && alert.snippet, \'fa-info-circle\': alert.style === \'info\' && !alert.snippet, \'fa-info\': alert.style === \'info\' && alert.snippet, \'fa-exclamation-circle\': alert.style === \'warning\' && !alert.snippet, \'fa-exclamation-triangle\': alert.style === \'warning\' && alert.snippet, \'fa-times\': alert.style === \'danger\', \'fa-bullhorn\': alert.banner}"></i><div class="alert-content-wrapper"><ga-value-template value="alert.text" scope-level="{{scopeLevel || 4}}"></ga-value-template><div class="alert-actions" ng-if="alert.banner && alert.actions"><i ng-if="alert.actions.accept" ng-click="alertAction(alert, $index, alert.actions.accept)" class="ion ion-ios-checkmark-outline"></i><i ng-if="alert.actions.dismiss" ng-click="alertAction(alert, $index, alert.actions.dismiss)" class="ion ion-ios-close-outline"></i></div></div></alert></div>',scope:{type:"@",name:"@",scopeLevel:"=?"},link:function(scope,elm,attrs){var type=angular.isDefined(scope.type)?scope.type:"page",name=angular.isDefined(scope.name)?scope.name:null;scope.toggleTimer=function(pause,index){var alerts=$alertStack.getAlerts(type,name);pause?$alertStack.pauseTimer(alerts,index):$alertStack.resumeTimer(alerts,index)},$alertStack.registerSystem(type,name,function(alerts){$timeout(function(){0!==alerts.length&&angular.isDefined(attrs.appearance)&&"snippet"===attrs.appearance&&(alerts[alerts.length-1].snippet=!0),0!==alerts.length&&angular.isDefined(attrs.appearance)&&"banner"===attrs.appearance&&(alerts[alerts.length-1].banner=!0),scope.alerts=alerts})}),$alertStack.setScrollElement(type,name,elm),elm.addClass("alert-system"),"page"===type?elm.addClass("page"):"app"===type&&elm.addClass("app"),scope.closeAlert=function(alert,index){$alertStack.close(alert,index)},scope.alertAction=function(alert,index,action){action(),scope.closeAlert(alert,index)},scope.$on("$destroy",function(){var alerts=$alertStack.getAlerts(type,name);angular.isDefined(alerts)&&0===alerts.length&&$alertStack.deleteSystem(type,name)})}}}]).factory("$errors",["$alert",function($alert){return{output:function(options,error){var errorAlerts=[],fieldError=!1;if(error&&"object"==typeof error){for(var key in error)"detail"===key?errorAlerts.push(error[key]):"non_field_errors"===key?errorAlerts.push(error[key][0]):fieldError=!0;!0===fieldError&&errorAlerts.push("Please ensure all required fields are properly completed.")}else angular.isDefined(options.defaultMessage)?errorAlerts.push(options.defaultMessage):errorAlerts.push("Something went wrong. Please try again or contact support.");for(var i=0;i<errorAlerts.length;i++)if(i<2){var alertConfig={type:options.alertSystemType?options.alertSystemType:"page",name:options.alertSystem,timer:void 0===options.alertTimer||!0===options.alertScroll,timerVal:options.alertTimerVal?options.alertTimerVal:4e3,register:!0,style:"danger",text:errorAlerts[i]};angular.isDefined(options.alertScroll)&&(alertConfig.scroll=options.alertScroll),angular.isDefined(options.alertScrollToError)&&(alertConfig.scrollToAlert=options.alertScrollToError),angular.isDefined(options.alertScrollOffset)&&(alertConfig.scrollOffset=options.alertScrollOffset),"page"===alertConfig.type&&(alertConfig.register=!1),$alert.add(alertConfig)}}}}]);