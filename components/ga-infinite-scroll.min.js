angular.module("ngAmbassador.infiniteScroll",["infinite-scroll","angularSpinner","ngAmbassador.services","ngAmbassador.api","ngAmbassador.alerts"]).directive("gaInfiniteScroll",["$api","$diff","$errors","$promiseKeeper","$q",function($api,$diff,$errors,$promiseKeeper,$q){"use strict";return{restrict:"E",transclude:!0,scope:!0,template:'<div id="infinite-container" infinite-scroll="nextPage()" infinite-scroll-disabled="loadingNextPage"></div><div class="infinite-spinner" ng-if="loadingNextPage && (currentPage > 1 || updatingData)" us-spinner="infiniteSpinner"></div><alert-system name="infinite-scroll-alerts" type="page"></alert-system>',link:function(scope,element,attrs,ctrl,transclude){scope.endpoint=attrs.endpoint,scope.distance=attrs.distance,scope.currentPage=1,scope.loadingNextPage=!1,scope.updatingData=!1,scope.items=[],scope.count=0,scope.scollDistance="undefined"!=typeof scope.distance?scope.distance:1,scope.initialGet=!0,scope.initialGetLoading=!0,scope.infiniteSpinner={radius:5,width:3,length:4,lines:10,color:"#94A4A5"},scope.queryParams={};var abortSearch,initializePromise=$promiseKeeper.add();attrs.$observe("params",function(params){"undefined"!=typeof params&&""!==params&&(scope.queryParams=JSON.parse(params))}),scope.nextPage=function(){1===scope.currentPage&&initializePromise.deferred.resolve();var queryParams=angular.extend({},scope.queryParams);queryParams.page=scope.currentPage,scope.loadingNextPage||0!==scope.count&&scope.count<=scope.items.length||(scope.loadingNextPage=!0,$api.use("default").all(scope.endpoint).getList(queryParams).then(function(data){if(scope.initialGetLoading=!1,scope.count=data.count,0!==data.count){for(var i=0;i<data.length;i++)scope.items.push(data[i]);scope.currentPage++,queryParams.page=scope.currentPage,scope.loadingNextPage=!1,scope.initialGet=!1}},function(error){scope.initialGetLoading=!1,0!==error.status&&$errors.output({alertSystem:"infinite-scroll-alerts",alertSystemType:"page",defaultMessage:"Something went wrong while trying to get the data. Please try again or contact support."},error.data)}))},scope.updateData=function(){"undefined"!=typeof abortSearch&&abortSearch.resolve(),abortSearch=$q.defer(),scope.currentPage=1,scope.loadingNextPage=!0,scope.updatingData=!0;var queryParams=angular.extend({},scope.queryParams);queryParams.page=scope.currentPage,$api.use("default").all(scope.endpoint).withHttpConfig({timeout:abortSearch.promise}).getList(queryParams).then(function(data){if(scope.items=[],scope.count=data.count,scope.loadingNextPage=!1,scope.updatingData=!1,0!==data.count){for(var i=0;i<data.length;i++)scope.items.push(data[i]);scope.currentPage=2,queryParams.page=scope.currentPage}},function(error){0!==error.status&&$errors.output({alertSystem:"infinite-scroll-alerts",alertSystemType:"page",defaultMessage:"Something went wrong while trying to get the data. Please try again or contact support."},error.data)})},scope.$watch("queryParams",function(newValue,oldValue){$diff.compare(oldValue,newValue)&&scope.updateData()},!0),transclude(scope,function(clone,scope){angular.element(element.find("div")[0]).append(clone)})}}}]);