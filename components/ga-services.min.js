angular.module("ngAmbassador.services",[]).factory("$helper",function(){return{colorLuminance:function(hex,lum){(hex=String(hex).replace(/[^0-9a-f]/gi,"")).length<6&&(hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2]),lum=lum||0;var c,i,rgb="#";for(i=0;i<3;i++)c=parseInt(hex.substr(2*i,2),16),rgb+=("00"+(c=Math.round(Math.min(Math.max(0,c+c*lum),255)).toString(16))).substr(c.length);return rgb},sum:function(obj,key){for(var sum=0,i=0;i<obj.length;i++)sum+=parseFloat(obj[i][key]);return sum}}}).factory("$promiseKeeper",["$q","$timeout",function($q,$timeout){var $promiseKeeper={},promises=[],promiseData=[],keeperStartTime=null,keeperConfig={expect:0,timeout:30,success:function(){},loading:function(){}},promiseConfig={id:"promise",status:"new"},_resetPromises=function(){promises=[],promiseData=[],keeperStartTime=null};return $promiseKeeper.getActive=function(){return 0<promiseData.length&&promiseData},$promiseKeeper.config=function(config){keeperConfig=angular.extend(keeperConfig,config)},$promiseKeeper.add=function(config){var deferred=$q.defer(),promiseConf=angular.extend(angular.copy(promiseConfig),config);promiseConf.promise=deferred.promise,promiseConf.deferred=deferred,promiseConf.status="loading",promiseConf.id="promise"+(parseInt(promises.length)+1),promiseConf.start=(new Date).getTime(),promiseData.push(promiseConf),promises.push(deferred.promise),null===keeperStartTime&&(keeperStartTime=(new Date).getTime());var promiseTimeout=$timeout(function(){promiseConf.status="timeout",promiseConf.deferred.reject(promiseConf)},1e3*parseInt(keeperConfig.timeout)-(promiseConf.start-keeperStartTime));return promiseConf.promise.then(function(){$timeout.cancel(promiseTimeout),promiseConf.status="success"}),function(){"function"==typeof keeperConfig.loading&&keeperConfig.loading();var promiseCount=promises.length;$q.all(promises).finally(function(){"function"==typeof keeperConfig.success&&promises.length===promiseCount&&(keeperConfig.success(),_resetPromises())})}(),promiseConf},$promiseKeeper}]).factory("$script",["$q",function($q){var $script={load:function(urls,callback){var promises=[];return angular.forEach(urls,function(url){var scriptPromise=$q.defer();promises.push(scriptPromise.promise);for(var head=document.getElementsByTagName("head")[0],script=null,allScripts=head.getElementsByTagName("script"),i=allScripts.length-1;0<=i;i--){var sc=allScripts[i],gaLoaded=sc.getAttribute("ga-loaded");if(null!==gaLoaded&&url===sc.getAttribute("src")){if("true"===gaLoaded)return void scriptPromise.resolve();script=sc;break}}null===script&&((script=document.createElement("script")).type="text/javascript",script.src=url,script.setAttribute("ga-loaded","false"),head.appendChild(script)),script.addEventListener?script.addEventListener("load",function(){script.setAttribute("ga-loaded","true"),scriptPromise.resolve()},!1):script.onreadystatechange=function(){"loaded"===script.readyState&&(script.setAttribute("ga-loaded","true"),scriptPromise.resolve())}}),$q.all(promises)}};return $script}]).factory("$browserDetect",[function(){var $browserDetect={},_dataBrowser=[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],_dataOS=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}];function _searchString(data){for(var i=0;i<data.length;i++){var dataString=data[i].string,dataProp=data[i].prop;if(this.versionSearchString=data[i].versionSearch||data[i].identity,dataString){if(-1!==dataString.indexOf(data[i].subString))return data[i].identity}else if(dataProp)return data[i].identity}}function _searchVersion(dataString){var index=dataString.indexOf(this.versionSearchString);if(-1!==index)return parseFloat(dataString.substring(index+this.versionSearchString.length+1))}return $browserDetect.name=_searchString(_dataBrowser)||!1,$browserDetect.version=_searchVersion(navigator.userAgent)||_searchVersion(navigator.appVersion)||!1,$browserDetect.OS=_searchString(_dataOS)||!1,$browserDetect}]).factory("$diff",[function(){var $diff={compare:function(original,toCompare,emptyStringIsNotNull){var objectDiff={},objectsEqual=!0;return objectDiff.diff=function(a,b){var oldKeys=_.keys(a),newKeys=_.keys(b),removed=_.difference(oldKeys,newKeys),union=_.union(newKeys,oldKeys),changes={};return _.each(union,function(k){!emptyStringIsNotNull&&(null===a[k]&&""===b[k]||""===a[k]&&null===b[k])||_.isFunction(a[k])||_.isFunction(b[k])||(_.isDate(a[k])&&_.isDate(b[k])?_.isEqual(new Date(a[k]).setHours(0,0,0,0),new Date(b[k]).setHours(0,0,0,0)):"number"==typeof a[k]||"number"==typeof b[k]?_.isEqual(+a[k],+b[k]):_.isEqual(a[k],b[k]))||(objectsEqual=!1,changes[k]=b[k])}),_.each(removed,function(k){_.isFunction(a[k])||_.isFunction(b[k])||(changes[k]="")}),!objectsEqual&&changes},objectDiff.diff(original,toCompare)}};return $diff}]);